@page "/reports/profit-product"
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthService Auth

@if (!IsAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <h3>Profit by Product Report</h3>

    <div class="row g-2 mb-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">From</label>
            <InputDate class="form-control" @bind-Value="from" />
        </div>
        <div class="col-md-3">
            <label class="form-label">To</label>
            <InputDate class="form-control" @bind-Value="to" />
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" @onclick="LoadReport">Load</button>
        </div>
        @if (entries.Any())
        {
            <div class="col-md-2 d-grid">
                <button class="btn btn-outline-success" @onclick="ExportCsv">Export CSV</button>
            </div>
        }
    </div>

    <table class="table table-striped" hidden="@(entries.Count==0)">
        <thead>
            <tr>
                <th>Product</th>
                <th class="text-end">Quantity</th>
                <th class="text-end">Profit</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in entries)
            {
                <tr>
                    <td>@e.Name</td>
                    <td class="text-end">@e.Quantity</td>
                    <td class="text-end">@e.Profit:C</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private DateTime from = DateTime.Today;
    private DateTime to = DateTime.Today;
    private List<ProfitEntry> entries = new();
    private bool IsAuthorized => Auth.CurrentUser is { Role: Role.Admin };

    protected override void OnInitialized()
    {
        if (!IsAuthorized)
            Nav.NavigateTo("/login", true);
    }

    private async Task LoadReport()
    {
        var url = $"/reports/profit/product?from={from:O}&to={to:O}";
        entries = await Http.GetFromJsonAsync<List<ProfitEntry>>(url) ?? new();
    }

    private void ExportCsv()
    {
        var url = $"/reports/profit/product/export?from={from:O}&to={to:O}";
        Nav.NavigateTo(url, true);
    }
}